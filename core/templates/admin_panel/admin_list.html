{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_panel.css' %}">
{% endblock %}
{% block content %}
<div class="admin-container panel-{{ panel }}">
  {% if panel == 'events' %}
    <h1>Manage Events</h1>

    <div class="action-search-row">
      <div class="search">
        <form method="get" action="{% url 'admin_event_list' %}" class="search-form" role="search">
          <button type="button" class="back-button" title="Go back" aria-label="Go back" onclick="window.history.back();">
            <img src="{% static 'img/back-icon.png' %}" alt="Back" class="back-icon">
          </button>
          <input type="text" name="q"
            placeholder="{% if panel == 'users' %}Search users...
                          {% elif panel == 'events' %}Search events...
                          {% elif panel == 'updates' %}Search updates...
                          {% else %}Search...
                          {% endif %}"
            value="{{ query }}">
          <button type="submit">Search</button>
        </form>
      </div>
      <div class="left-actions">
        <a href="#" data-open-modal="#eventModal" class="btn-success"> ‚úçÔ∏è Add Event</a>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Visibility</th>
          <th>Date Posted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for event in events %}
          <tr {% if event.done or event.date < today.date or event.date == today.date and event.time <= today.time %}class="done-event"{% endif %}>
            <td><a href="#" class="admin-detail-link" data-url="{% url 'event_detail' event.pk %}">{{ event.title|truncatechars:20 }}</a></td>
            <td>{{ event.date }}</td>
            <td>
              <strong>{{ event.get_visibility_type_display }}</strong><br>
              {% if event.visibility_type == "batch" or event.visibility_type == "batch_degree" %}
                <span>
                  {% for batch in event.visibility_batches.all %}
                    {{ batch.year }}{% if not forloop.last %}, {% endif %}
                  {% empty %}None{% endfor %}
                </span>
              {% endif %}
              {% if event.visibility_type == "degree" or event.visibility_type == "batch_degree" %}
                <span>
                  {% for degree in event.visibility_degrees.all %}
                    {{ degree.code }}{% if not forloop.last %}, {% endif %}
                  {% empty %}None{% endfor %}
                </span>
              {% endif %}
            </td>
            <td>{{ event.created_at|date:"Y-m-d H:i" }}</td>
            <td>
                {% if event.done %}
                <span style="color: gray; cursor: not-allowed;">Edit</span> |
                <a href="{% url 'admin_event_delete' event.id %}" data-confirm="Are you sure you want to delete this event?">Delete</a>
              {% else %}
                {% if event.date %}
                  <a href="#" data-open-modal="#eventModal" data-edit-url="{% url 'admin_event_edit' event.id %}" data-title="{{ event.title|escapejs }}" data-description="{{ event.description|escapejs }}" data-date="{{ event.date }}" data-time="{{ event.time }}" data-location="{{ event.location|default_if_none:''|escapejs }}">Edit</a> |
                  <a href="{% url 'admin_event_delete' event.id %}" data-confirm="Are you sure you want to delete this event?">Delete</a> 
                {% else %}
                  <a href="#" data-open-modal="#eventModal" data-edit-url="{% url 'admin_event_edit' event.id %}">Edit</a> |
                  <a href="{% url 'admin_event_delete' event.id %}" data-confirm="Are you sure you want to delete this event?">Delete</a> |
                  <a href="{% url 'admin_event_mark_done' event.id %}" data-confirm="Mark this event as done?">Mark as Done</a>
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6">No events found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

  {% elif panel == 'updates' %}
    <h1 class="mb-4">Manage Updates</h1>

    <div class="action-search-row">
      <div class="search">
        <form method="get" action="{% url 'admin_updates_list' %}" class="mb-3 d-flex search-form" role="search">
          <button type="button" class="back-button" title="Go back" aria-label="Go back" onclick="window.history.back();">
            <img src="{% static 'img/back-icon.png' %}" alt="Back" class="back-icon">
          </button>
          <input type="text" name="q"
            placeholder="{% if panel == 'users' %}Search users...
                          {% elif panel == 'events' %}Search events...
                          {% elif panel == 'updates' %}Search updates...
                          {% else %}Search...
                          {% endif %}"
            value="{{ query }}">
          <button type="submit" class="btn btn-outline-primary">Search</button>
        </form>
      </div>
      <div class="left-actions">
        <a href="#" data-open-modal="#updatesModal" class="btn btn-primary mb-3"> ‚úçÔ∏è Add New Update</a>
      </div>
    </div>

    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Related Event</th>
          <th>Visibility</th>
          <th>Date Posted</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for update in updates %}
        <tr>
          <td><a href="#" class="admin-detail-link" data-url="{% url 'update_detail' update.pk %}">{{ update.title }}</a></td>
          <td>
            {% if update.related_event %}
              {{ update.related_event.title }}
            {% else %}
              <em>No related event</em>
            {% endif %}
          </td>
          <td>
            <strong>{{ update.get_visibility_type_display }}</strong><br>
            {% if update.visibility_type == "batch" or update.visibility_type == "both" %}
              <span>
                {% for batch in update.visibility_batches.all %}
                  {{ batch.year }}{% if not forloop.last %}, {% endif %}
                {% empty %}None{% endfor %}
              </span>
            {% endif %}
            {% if update.visibility_type == "degree" or update.visibility_type == "both" %}
              <span>
                {% for degree in update.visibility_degrees.all %}
                  {{ degree.code }}{% if not forloop.last %}, {% endif %}
                {% empty %}None{% endfor %}
              </span>
            {% endif %}
          </td>
          <td>{{ update.date_posted|date:"Y-m-d H:i" }}</td>
          <td>
            <a href="#" data-open-modal="#updatesModal" data-edit-url="{% url 'admin_updates_edit' update.id %}" data-title="{{ update.title|escapejs }}" data-content="{{ update.content|escapejs }}" data-related-event="{% if update.related_event %}{{ update.related_event.id }}{% endif %}">Edit</a> |
            <a href="{% url 'admin_updates_delete' update.id %}" data-confirm="Are you sure you want to delete this update?">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No updates available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  {% elif panel == 'forum' %}
    <h1>Forum Posts</h1>

    <div class="action-search-row">
      <div class="search">
        <form method="get" action="{% url 'admin_forum_list' %}" class="search-form" style="margin-bottom: 30px;" role="search">
          <button type="button" class="back-button" title="Go back" aria-label="Go back" onclick="window.history.back();">
            <img src="{% static 'img/back-icon.png' %}" alt="Back" class="back-icon">
          </button>
          <input type="text" name="q"
            placeholder="{% if panel == 'users' %}Search users...
                          {% elif panel == 'events' %}Search events...
                          {% elif panel == 'updates' %}Search updates...
                          {% else %}Search...
                          {% endif %}"
            value="{{ query }}">
          <button type="submit">Search</button>
        </form>
      </div>
      <div class="left-actions">
        <!-- reserved for forum actions (e.g., Add Post) -->
      </div>
    </div>

    {% for post in posts %}
    <div class="post">
      <strong><a href="#" class="admin-detail-link" data-url="{% url 'user_profile' post.author.pk %}">{{ post.author.get_full_name }}</a></strong> |
      {{ post.date_posted|date:"M d, Y H:i" }}

      <p><strong><a href="#" class="admin-detail-link" data-url="{% url 'forum_detail' post.pk %}">{{ post.title }}</a></strong></p>
      <p>{{ post.content }}</p>

      <form method="post" action="{% url 'admin_delete_post' post.id %}"
        data-confirm="Are you sure you want to delete this post? This cannot be undone.">
        {% csrf_token %}
        <button type="submit" class="delete-button">üóë Delete</button>
      </form>

      <div class="comments">
        <strong>Comments:</strong>
        {% for comment in post.comments.all %}
        <div class="comment">
          <small><strong>{{ comment.user.get_full_name }}</strong> |
          {{ comment.date_posted|date:"M d, Y H:i" }}</small>
          <p>{{ comment.content }}</p>
        </div>
        {% empty %}
        <p><i>No comments yet.</i></p>
        {% endfor %}
      </div>
    </div>
    {% empty %}
    <p>No forum posts available.</p>
    {% endfor %}

  {% elif panel == 'users' %}
    <h1>Manage Users</h1>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
    <div class="action-search-row">
      <div class="search">
        <form method="get" action="{% url 'admin_user_list' %}" class="search-form" style="margin-bottom: 20px;" role="search">
          <button type="button" class="back-button" title="Go back" aria-label="Go back" onclick="window.history.back();">
            <img src="{% static 'img/back-icon.png' %}" alt="Back" class="back-icon">
          </button>
          <input type="text" name="q"
            placeholder="{% if panel == 'users' %}Search users...
                          {% elif panel == 'events' %}Search events...
                          {% elif panel == 'updates' %}Search updates...
                          {% else %}Search...
                          {% endif %}"
            value="{{ query }}">
          <button type="submit">Search</button>
        </form>
      </div>
      <div class="left-actions">
        <a href="#" data-open-modal="#userModal" class="btn btn-primary">‚ûï Add New User</a>
        <a href="#" data-open-modal="#csvModal" class="btn btn-secondary">üìÅ Batch Upload via CSV</a>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Name</th>
          <th>Address</th>
          <th>Degree</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
          <tr>
            <td>{{ user.id }}</td>
            <td><a href="#" class="admin-detail-link" data-url="{% url 'user_profile' user.pk %}">{{ user.student_number|default:user.username }}</a></td>
            
            <td><a href="#" class="admin-detail-link" data-url="{% url 'user_profile' user.pk %}">{{ user.full_name }}</a></td>
            <td>{{ user.address }}</td>
            <td>{% if user.is_staff %}
              <em>Admin User</em>
            {% else %}
              {{ user.degree }}
            {% endif %}</td>
            <td>
              <a href="#" data-open-modal="#userModal" data-edit-url="{% url 'admin_user_edit' user.id %}">Edit</a> |
              <a href="{% url 'admin_user_reset_password' user.id %}" data-confirm="Reset password?">Reset</a> |
              {% if user.is_active %}
                <a href="{% url 'admin_user_delete' user.id %}" data-confirm="Delete user?">Delete</a>
              {% else %}
                <em>Inactive</em>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">No users found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

  {% else %}
    <p>No admin panel selected.</p>
  {% endif %}

  <div class="pagination">
    {% if page_obj %}
      <span class="page-info">SHOWING PAGE {{ page_obj.number }} OF {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="page-link">Previous</a>
      {% endif %}

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="page-link">Next</a>
      {% endif %}
    {% endif %}
  </div>
  
</div>
  
  {% block scripts %}
  <script>
    function openDetailModal(html){
      const modal = document.getElementById('detailModal');
      const body = document.getElementById('detail-modal-body');
      if(!modal || !body) return;
      body.innerHTML = html;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      document.body.classList.add('modal-opened');
    }

    function loadAdminDetail(url){
      const body = document.getElementById('detail-modal-body');
      if(body) body.innerHTML = '<p>Loading...</p>';
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
        .then(r => { if(!r.ok) throw new Error('Failed'); return r.text(); })
        .then(html => openDetailModal(html))
        .catch(() => openDetailModal('<p>Error loading details.</p>'));
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.admin-detail-link').forEach(function(el){
        el.addEventListener('click', function(e){
          e.preventDefault();
          const url = this.getAttribute('data-url');
          if(url) loadAdminDetail(url);
        });
      });

      // Close behavior for the shared modal (button & backdrop click)
      document.addEventListener('click', function(e){
        if(e.target.classList.contains('modal-close')){
          const modal = e.target.closest('.modal-overlay');
          if(modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-opened'); }
        }
        if(e.target.classList && e.target.classList.contains('modal-overlay')){
          e.target.classList.remove('open'); e.target.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-opened');
        }
      });
    });
  </script>
  {% endblock %}
{% endblock %}
