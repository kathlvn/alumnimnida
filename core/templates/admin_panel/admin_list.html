{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_panel.css' %}">
{% endblock %}
{% block content %}
<div class="admin-container panel-{{ panel }}">
  {% if panel == 'events' %}
    <h1>Manage Events</h1>

    <form method="get" action="">
      <input type="text" name="q" placeholder="Search events..." value="{{ query }}">
      <button type="submit">Search</button>
    </form>

    <!-- Add Event Button -->
    <a href="{% url 'admin_event_create' %}" class="btn-success">Add Event</a>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Date</th>
          <th>Created</th>
          <th>Visibility</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for event in events %}
          <tr {% if event.done or event.date < today.date or event.date == today.date and event.time <= today.time %}class="done-event"{% endif %}>
            <td>{{ event.title|truncatechars:20 }}</td>
            <td>{{ event.date }}</td>
            <td>{{ event.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              <strong>{{ event.get_visibility_type_display }}</strong><br>
              {% if event.visibility_type == "batch" or event.visibility_type == "batch_degree" %}
                <span>
                  {% for batch in event.visibility_batches.all %}
                    {{ batch.year }}{% if not forloop.last %}, {% endif %}
                  {% empty %}None{% endfor %}
                </span>
              {% endif %}
              {% if event.visibility_type == "degree" or event.visibility_type == "batch_degree" %}
                <span>
                  {% for degree in event.visibility_degrees.all %}
                    {{ degree.code }}{% if not forloop.last %}, {% endif %}
                  {% empty %}None{% endfor %}
                </span>
              {% endif %}
            </td>
            <td>
              {% if event.done %}
                <span style="color: gray; cursor: not-allowed;">Edit</span> |
                <a href="{% url 'admin_event_delete' event.id %}" onclick="return confirm('Are you sure you want to delete this event?')">Delete</a> |
                <em>Done</em>
              {% else %}
                {% if event.date %}
                  <a href="{% url 'admin_event_edit' event.id %}">Edit</a> |
                  <a href="{% url 'admin_event_delete' event.id %}" onclick="return confirm('Are you sure you want to delete this event?')">Delete</a> |
                  <em>Done</em>
                {% else %}
                  <a href="{% url 'admin_event_edit' event.id %}">Edit</a> |
                  <a href="{% url 'admin_event_delete' event.id %}" onclick="return confirm('Are you sure you want to delete this event?')">Delete</a> |
                  <a href="{% url 'admin_event_mark_done' event.id %}" onclick="return confirm('Mark this event as done?')">Mark as Done</a>
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6">No events found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

  {% elif panel == 'updates' %}
    <h1 class="mb-4">Manage Updates</h1>

    <form method="get" class="mb-3 d-flex" role="search">
      <input type="text" name="q" value="{{ query }}" class="form-control me-2" placeholder="Search updates...">
      <button type="submit" class="btn btn-outline-primary">Search</button>
    </form>

    <a href="{% url 'admin_updates_create' %}" class="btn btn-primary mb-3">Add New Update</a>

    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Related Event</th>
          <th>Date Posted</th>
          <th>Visibility</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for update in updates %}
        <tr>
          <td>{{ update.title }}</td>
          <td>
            {% if update.related_event %}
              {{ update.related_event.title }}
            {% else %}
              <em>No related event</em>
            {% endif %}
          </td>
          <td>{{ update.date_posted|date:"Y-m-d H:i" }}</td>
          <td>
            <strong>{{ update.get_visibility_type_display }}</strong><br>
            {% if update.visibility_type == "batch" or update.visibility_type == "both" %}
              <span>
                {% for batch in update.visibility_batches.all %}
                  {{ batch.year }}{% if not forloop.last %}, {% endif %}
                {% empty %}None{% endfor %}
              </span>
            {% endif %}
            {% if update.visibility_type == "degree" or update.visibility_type == "both" %}
              <span>
                {% for degree in update.visibility_degrees.all %}
                  {{ degree.code }}{% if not forloop.last %}, {% endif %}
                {% empty %}None{% endfor %}
              </span>
            {% endif %}
          </td>
          <td>
            <a href="{% url 'admin_updates_edit' update.id %}" class="btn btn-sm btn-warning">Edit</a>
            <a href="{% url 'admin_updates_delete' update.id %}" class="btn btn-sm btn-danger"
               onclick="return confirm('Are you sure you want to delete this update?');">Delete</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted">No updates available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

  {% elif panel == 'forum' %}
    <h1>Forum Posts</h1>

    <form method="get" style="margin-bottom: 30px;">
      <input type="text" name="q" placeholder="Search posts or authors" value="{{ query }}" />
      <button type="submit">Search</button>
    </form>

    {% for post in posts %}
    <div class="post">
      <strong>{{ post.author.get_full_name }}</strong> |
      {{ post.date_posted|date:"M d, Y H:i" }}

      <p><strong>{{ post.title }}</strong></p>
      <p>{{ post.content }}</p>

      <form method="post" action="{% url 'admin_delete_post' post.id %}"
            onsubmit="return confirm('Are you sure you want to delete this post? This cannot be undone.');">
        {% csrf_token %}
        <button type="submit" class="delete-button">üóë Delete</button>
      </form>

      <div class="comments">
        <strong>Comments:</strong>
        {% for comment in post.comments.all %}
        <div class="comment">
          <small><strong>{{ comment.user.get_full_name }}</strong> |
          {{ comment.date_posted|date:"M d, Y H:i" }}</small>
          <p>{{ comment.content }}</p>
        </div>
        {% empty %}
        <p><i>No comments yet.</i></p>
        {% endfor %}
      </div>
    </div>
    {% empty %}
    <p>No forum posts available.</p>
    {% endfor %}

  {% elif panel == 'users' %}
    <h1>Manage Users</h1>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="get" action="{% url 'admin_user_list' %}" style="margin-bottom: 20px;">
      <input type="text" name="q" value="{{ request.GET.q|default:'' }}" placeholder="Search users...">
      <button type="submit">Search</button>
    </form>

    <div class="action-row">
      <div class="left-actions">
        <a href="{% url 'admin_user_create' %}" class="btn btn-primary">‚ûï Add New User</a>
        <a href="{% url 'admin_user_batch_upload' %}" class="btn btn-secondary">üìÅ Batch Upload via CSV</a>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Name</th>
          <th>Address</th>
          <th>Degree</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
          <tr>
            <td>{{ user.id }}</td>
            <td>{{ user.student_number|default:user.username }}</td>
            <td>{{ user.full_name }}</td>
            <td>{{ user.address }}</td>
            <td>{{ user.degree }}</td>
            <td>
              <a href="{% url 'admin_user_edit' user.id %}">Edit</a> |
              <a href="{% url 'admin_user_reset_password' user.id %}" onclick="return confirm('Reset password?')">Reset</a> |
              {% if user.is_active %}
                <a href="{% url 'admin_user_delete' user.id %}" onclick="return confirm('Delete user?')">Delete</a>
              {% else %}
                <em>Inactive</em>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8">No users found.</td></tr>
        {% endfor %}
      </tbody>
    </table>

  {% else %}
    <p>No admin panel selected.</p>
  {% endif %}

  <div class="pagination">
    {% if page_obj %}
      <span class="page-info">SHOWING PAGE {{ page_obj.number }} OF {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="page-link">Previous</a>
      {% endif %}

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="page-link">Next</a>
      {% endif %}
    {% endif %}
  </div>
  
</div>
{% endblock %}
