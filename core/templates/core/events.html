{% extends 'base.html' %}
{% load static %}

{% block title %}Events{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/events.css' %}">
{% endblock %}

{% block page_title %}
EVENTS
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <!-- Events List -->
  <div class="events-section">
    <div class="top-row">
    <form method="get" class="filter-form">
      <label for="visibility">Filter by: </label>
      <select name="visibility" id="visibility" onchange="this.form.submit()">
        <option value="" {% if not visibility_filter %}selected{% endif %}>All</option>
        <option value="batch" {% if visibility_filter == 'batch' %}selected{% endif %}>My Batch</option>
        <option value="degree" {% if visibility_filter == 'degree' %}selected{% endif %}>My Degree</option>
      </select>
    </form>
    </div>    

    {% for event in events %}
    <div class="event-box">
      <a href="#" class="detail-link" data-url="{% url 'event_detail' event.pk %}">
        <h3 class="event-title">{{ event.title }}</h3>
        <p class="event-desc">{{ event.description|truncatechars:100 }}</p>
        <p><strong>Date:</strong> {{ event.date|date:"F d, Y" }}</p>
        <p><strong>Time:</strong> {{ event.time }}</p>
        <p><strong>Location:</strong> {{ event.location }}</p>
      </a>
    </div>
    {% empty %}
    <p>No events available.</p>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block right_panel %}
<div class="quick-stats">
  <h3 class="timeline-title">Recently Concluded Events</h3>
  <ul>
    {% for event in recently_concluded %}
    <li>
      <strong>{{ event.title }}</strong><br>
      {% if event.date %}
      <em>{{ event.date|date:"F d, Y" }}</em>
      {% else %}
      <em>Marked as Done</em>
      {% endif %}
    </li>
    {% empty %}
    <li>No recently concluded events.</li>
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
  function openDetailModalWithHTML(html){
    const modal = document.getElementById('detailModal');
    const body = document.getElementById('detail-modal-body');
    if(!modal || !body) return;
    body.innerHTML = html;
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-opened');
  }

  function loadDetail(url){
    const body = document.getElementById('detail-modal-body');
    if(body) body.innerHTML = '<p>Loading...</p>';
    fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
      .then(r => { if(!r.ok) throw new Error('Failed to load'); return r.text(); })
      .then(html => openDetailModalWithHTML(html))
      .catch(() => openDetailModalWithHTML('<p>Error loading detail view.</p>'));
  }

  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.detail-link').forEach(function(link){
      link.addEventListener('click', function(e){
        e.preventDefault();
        const url = this.getAttribute('data-url');
        if(!url) return;
        loadDetail(url);
      });
    });
  });
</script>
{% endblock %}
