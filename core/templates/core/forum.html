{% extends 'base.html' %}
{% load static %}

{% block page_title %}Forum{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
{% endblock %}

{% block sidebar %}
<!-- Optional: Sidebar links or navs -->
{% endblock %}

{% block main %}
<div class="forum-header">
  <h1>FORUM</h1>
  <input type="text" class="search-bar" placeholder="Search...">
</div>

<!-- Create Post Button -->
<button class="create-btn" onclick="openModal()">CREATE A POST</button>

<!-- Forum Posts -->
{% for post in posts %}
<div class="forum-post" id="post-{{ post.id }}">
  <h3><strong>{{ post.title|upper }}</strong></h3>
  <p>{{ post.content }}</p>
  <p><em>By {{ post.author.full_name }} • {{ post.date_posted|date:"F j, Y g:i A" }}</em></p>

  {% if post.author == request.user or request.user.is_staff %}
  <form method="POST" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="delete_post" value="{{ post.id }}">
    <button type="submit" class="delete-link" onclick="return confirm('Are you sure you want to delete this post?');">Delete</button>
  </form>
  {% endif %}

  <form method="POST" style="display:inline;">
    {% csrf_token %}
    <input type="hidden" name="like_post" value="{{ post.id }}">
    <button class="like-button" type="submit">Like ({{ post.likes.count }})</button>
  </form>

  <div class="comment-section">
    <strong>Comments</strong>
    {% for comment in post.comments.all %}
      <p>{{ comment.user.get_full_name }}: {{ comment.content }}
        {% if comment.user == request.user %}
          <a class="delete-link" href="{% url 'delete_comment' comment.id %}">Delete</a>
        {% endif %}
      </p>
    {% empty %}
      <p>No comments yet.</p>
    {% endfor %}

    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="comment_post" value="{{ post.id }}">
      <textarea name="comment_content" rows="2" class="comment-box" placeholder="Write a comment.."></textarea>
      <button class="send-btn" type="submit">Send</button>
    </form>
  </div>
</div>
{% endfor %}
{% endblock %}

{% block right_panel %}
<div class="trending-posts">
  <h3>Trending Posts</h3>
  <ul>
    {% for post in trending_posts %}
      <li><a href="#post-{{ post.id }}">• {{ post.title|truncatechars:40 }}</a></li>
    {% empty %}
      <li>No trending posts yet.</li>
    {% endfor %}
  </ul>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function openModal() {
    document.getElementById('postModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('postModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('postModal');
    if (event.target === modal) {
      closeModal();
    }
  }
</script>
{% endblock %}

{% block modal %}
<!-- Modal for creating a post -->
<div id="postModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Create Post</h2>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="create_post" value="1">
      <input type="text" name="title" placeholder="Title" class="modal-input" required><br>
      <textarea name="content" placeholder="Write your post..." rows="5" class="modal-input" required></textarea>
      <button type="submit" class="attend-button">Publish</button>
    </form>
  </div>
</div>
{% endblock %}
