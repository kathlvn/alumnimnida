{% extends 'base.html' %}
{% load static %}
{% block content %}
  <h2>Search Results for "{{ query }}"</h2>

  {% if users or admins or events or updates or forums %}
    {% if users %}
      <h4>Users</h4>
      <ul>
        {% for user in users %}
          <li>
            <a href="#" class="search-result-link" data-url="{% url 'user_profile' user.pk %}">
              {{ user.get_full_name }} ({{ user.student_number }})
            </a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if admins %}
      <h4>Admins</h4>
      <ul>
        {% for admin in admins %}
          <li>
            <a href="#" class="search-result-link" data-url="{% url 'user_profile' admin.pk %}">
              {{ admin.full_name }} ({{ admin.username }})
            </a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if events %}
      <h4>Events</h4>
      <ul>
        {% for event in events %}
          <li>
            <a href="#" class="search-result-link" data-url="{% url 'event_detail' event.pk %}">{{ event.title }}</a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if updates %}
      <h4>Updates</h4>
      <ul>
        {% for update in updates %}
          <li>
            <a href="#" class="search-result-link" data-url="{% url 'update_detail' update.pk %}">{{ update.title }}</a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if forums %}
      <h4>Forum Posts</h4>
      <ul>
        {% for forum in forums %}
          <li>
            <a href="#" class="search-result-link" data-url="{% url 'forum_detail' forum.pk %}">{{ forum.title }}</a>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% else %}
    <p>No results found.</p>
  {% endif %}

  <!-- Modal for search detail, scoped inside content -->
  <div id="searchDetailModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <span class="close-btn" onclick="closeSearchDetailModal()">&times;</span>
      <div id="search-detail-content" class="modal-body">
        <p>Loading...</p>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  function loadSearchDetail(url) {
    const modal = document.getElementById('searchDetailModal');
    const content = document.getElementById('search-detail-content');
    modal.style.display = 'flex';
    content.innerHTML = "<p>Loading...</p>";

    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error("Failed to load detail view");
        return response.text();
      })
      .then(html => {
        content.innerHTML = html;
      })
      .catch(() => {
        content.innerHTML = "<p>Error loading detail view.</p>";
      });
  }

  function closeSearchDetailModal() {
    document.getElementById('searchDetailModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('searchDetailModal');
    if (event.target === modal) {
      closeSearchDetailModal();
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.search-result-link').forEach(function (link) {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const url = this.getAttribute('data-url');
        loadSearchDetail(url);
      });
    });
  });
</script>
{% endblock %}

{% block extra_css %}
<style>
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-card {
    background: rgb(195, 15, 15);
    border-radius: 10px;
    padding: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  .close-btn {
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 24px;
    cursor: pointer;
  }
</style>
{% endblock %}
